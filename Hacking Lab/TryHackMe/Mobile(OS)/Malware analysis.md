![image 1](/Pictur/Hacking%20lab/malwareanalysis/1.png)<br>
A mobile malicious file will be analyzed.<br>
모바일 악성 파일을 분석하겠습니다. 
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/2.png)<br>
When the machine is started, two files are displayed on the initial screen.<br>
Both files have the APK extension, indicating that they are Android applications.<br>

머신을 시작하면 초기화면에 두 개의 파일이 보입니다. 두 개 모두 확장자가 apk로 안드로이드임을 알 수 있습니다. 
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/3.png)<br>
<br>
The files have unknown names, suggesting that they may be encrypted to conceal their identities.<br>
알 수 없는 이름으로, 이를 숨기기 위해 암호화 되어있음을 의심할 수 있습니다.
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/4.png)<br>
The files were encoded using a very simple Base64 scheme, and they were identified as Malware.apk.<br>
Base64로 아주 간단한 암호로 인코딩 되어있었으며, Malware.apk임을 확인했습니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/5.png)<br>
MobSF is an open-source mobile security analysis tool. The malicious file will be uploaded for analysis.<br>
MobSF는 오픈소스 모바일 보안 분석 도구입니다. 악성 파일을 업로드해 분석하겠습니다. 
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/6.png)<br>

From the package name (bundle ID), it can be inferred that the file is an attack tool associated with Metasploit, and SHA-256 will be used.<br>
Package Name인 번들 ID가 metasploit으로 공격도구임을 추론할 수 있으며, SHA256을 활용하겠습니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>

<img width="694" height="601" alt="image" src="https://github.com/user-attachments/assets/bb5bdcae-8e83-4bf8-9879-0ec33172364c" /><br>

VirusTotal is a malware scanning tool. The SHA-256 hash value will be submitted.<br>
WHY – SHA-256 can be used as a unique identifier for integrity verification.<br>

VirusTotal는 Malware 스캔 도구입니다. 여기에 SHA256 해시값을 붙여넣겠습니다.<br>
*WHY- SHA256는 고유 식별자로 무결성 검증이 가능합니다.

<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/7.png)<br>
By aggregating the scan results from numerous security vendors (AV engines),<br>
the file was confirmed to be identified as Metasploit-family malware.<br>

수많은 보안 업체(AV엔진)의 스캔 결과를 취합해 이를, Metasploit 계열의 악성코드로 식별됨을 확인했습니다. 
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
* Signer Certificate Analysis<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/10.png)<br>

In MobSF, the signer certificate analysis shows that although the application is signed,<br>
the signature relies on the vulnerable SHA-1 algorithm and uses a debug certificate, preventing verification of the developer’s identity.<br>

다시 MobSF로 돌아가서, 서명 및 인증서 보안성 검토(Signer Certificate Analysis)를 보겠습니다. <br>
secure로 서명은 되어있습니다. 이 서명이 SHA1으로 취약하며, debug certificate으로 정식 배포용이 아닌 제작자의 신원을 확인할 수 없습니다.<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
* Application Permission(Dangerous)<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/11.png)<br>
![image 1](/Pictur/Hacking%20lab/malwareanalysis/12.png)<br>

The review begins with dangerous application permissions.<br>
Access to coarse and fine location data allows real-time location tracking, which may facilitate user monitoring and data exfiltration.<br>

다음은, 앱 권한(Application Permission)을 보겠습니다. Dangerous부터 보겠습니다.<br>
각각, 대략적인 위치와 정밀한 위치파악으로 실시간 위치 추적이 가능하며, 사용자 감시 및 정보 탈취가 가능합니다.

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/13.png)<br>

In sequence, calls can be placed covertly without the victim’s consent, potentially enabling impersonation or financial harm.<br>
At any time, the camera can be used to capture images or record video, allowing user surveillance and information theft.<br>

순서대로, 피해자의 허가없이 몰래 전화를 걸어 사칭 또는 금전적 피해를 입을 수 있습니다.<br>
언제든지 카메라를 통해 촬영 녹화가 가능하며, 사용자 감시 및 정보 탈취가 가능합니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/14.png)<br>
![image 1](/Pictur/Hacking%20lab/malwareanalysis/17.png)<br>
Additionally, permissions to read and write call logs and the contact list are present.<br>
these can be abused to delete records of unauthorized calls, conceal malicious activity, manipulate contact information,<br>
and thereby avoid user suspicion.<br>

또한, 전화 기록과 전화번호부에 대해 읽고 쓰는 권한이 있습니다.<br>
무단 발신에 대한 기록을 삭제하며 은닉 및 연락처 정보를 조작하여 사용자의 의심을 피하는 등 악용할 수 있습니다. 
<br>
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/15.png)<br>

The READ_SMS permission allows messages stored on the device or SIM card to be read, posing potentially critical security risks depending on their content.<br>
The READ_PHONE_STATE permission enables retrieval of device-specific identifiers, which may facilitate long-term tracking if retained by an attacker.<br>

READ.SMS 먼저 보겠습니다. 핸드폰이나 유심카드에 저장되어있는 메세지를 볼 수 있습니다. 내용에 따라 치명적으로 작용할 수 있습니다.<br>
다음은, READ_PHONE_STATE로 기기 고유 번호를 확인할 수 있습니다.<br>
공격자의 DB에 저장될 경우, 핸드폰을 초기화를 하더라도 지속적으로 식별 및 추적하는 데 악용될 수 있습니다. 
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/16.png)<br>

The RECEIVE_SMS and SEND_SMS permissions allow messages to be sent and received without user involvement, enabling interception<br>
and deletion of incoming messages.<br>
The presence of RECORD_AUDIO in malware indicates direct audio surveillance, which also constitutes user monitoring and information theft.<br>

RECEIVE_SMS & SEND_SMS 사용자의 개입 없이 메세지를 보내며 수신하는 메시지를 가로채 메시지를 삭제할 수 있습니다.<br>
RECORD_AUDIOM가 Malware에 있을 경우 가장 직접적인 도청을 의미합니다. 이 또한 사용자 감시 및 정보 탈취의 경우입니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/18.png)<br>

There is an area referred to as external storage within Android, and read and write permissions are granted for this space.<br>
Additionally, permissions to modify system settings are present,<br>
which can be used to create an environment favorable to an attacker or to place the device in an unstable state that may cause malfunctions.<br>

안드로이드 내부의 외부 메모리라는 공간이 있습니다. 읽고 쓸 수 있는 권한입니다.<br>
다음은, 시스템 설정을 수정하는 권한으로 공격자에게 유리한 환경을 조성하거나 기기에 오류를 일으키는 불안정한 상태로 만들 수 있습니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

* Application Permission(Normal)<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/19.png)<br>

Normal permissions are granted during installation without requiring explicit user consent and can be used by an attacker as a foothold for further attacks. <br>
By monitoring Wi‑Fi status, a user’s location can be inferred, serving as a supplementary mechanism for location tracking.<br>
Additionally, Wi‑Fi connectivity can be used to determine optimal timing for transferring large files without using mobile data.<br> 
Although classified as normal, these permissions can be critically abused.<br>

Normal은 앱을 설치할 때 따로 동의를 구하지 않고 설치되는 앱으로, 공격자가 공격의 발판으로 사용합니다.<br>
와이파이 상태를 보고 사용자의 위치 파악이 가능합니다. 위치 추적 보조 역할로 쓰일 수 있습니다.<br>
또한, 데이터가 아닌 와이파이 상태일 때 공격자에게 대용량 파일 전송 타이밍을 잴 수 있습니다. Normal이지만, 치명적으로 악용될 수 있습니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/20.png)<br>
The CHANGE_WIFI_STATE permission allows forced attempts to connect to Wi‑Fi networks, securing a channel for data transmission.<br>
The INTERNET permission enables the creation of sockets, which function as a highway connecting the device to an attacker’s command-and-control (C2) server.<br>

CHANGE_WIFI_STATE는 와이파이에 강제로 접속을 시도해 데이터 전송 통로를 확보합니다.<br>
INTERNET은 socket을 생성하는데, socket은 C2(Command and control)로 공격자의 서버와 연결되는 원격제어 채널입니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>


![image 1](/Pictur/Hacking%20lab/malwareanalysis/21.png)<br>

The RECEIVE_BOOT_COMPLETED permission ensures that previously analyzed activities,<br>
such as audio surveillance, location tracking, and connection to a C2 server—are automatically initiated and remain resident in memory upon device boot.<br>
It is regarded as a core mechanism for maintaining persistent malicious behavior.<br>
At this stage, unusually long boot times or reduced device performance may lead the victim to suspect an infection.<br>

RECEIVE_BOOT_COMPLITED는 부팅 시에 앞서 분석한 도청 및 위치 추적, C2 서버로의 연결 등이 자동으로 프로세스에 상주시킵니다.<br>
악성행위를 영구적으로 지속하기 위한 핵심장치로 간주됩니다.<br>
* 이때, 부팅이 오래 걸린다거나 핸드폰이 느려질 경우 피해자는 감염을 의심할 수 있습니다. 
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/22.png)<br>

The SET_WALLPAPER permission allows the wallpaper to be changed to messages,<br>
such as ‘Your phone has been hacked,’ which can induce severe panic and be used to demand payment.<br>
The WAKE_LOCK permission keeps the CPU running in the background even when the screen is off,<br>
allowing continuous malicious activities—such as data exfiltration, audio surveillance, and recording—to persist without interruption.<br>

SET_WALLPAPER는 "너의 핸드폰은 해킹되었다"는 등의 배경화면을 바꿀 수 있으며, 금전을 요구하는 등 심각한 패닉 상태를 초래할 수 있습니다.<br>
WAKE_LOCK은 화면이 꺼져도, 백그라운드에서 CPU는 멈추지 않고 작동하게 해 끊임없이 공격자에게 데이터 전송하거나 도청 및 촬 같은 악성 행위를<br> 
중단 없이 지속하게 합니다. 
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
* Files <br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/20-1.png)<br>

The previously analyzed malicious permissions must be declared in AndroidManifest.xml in order to be granted by the system.<br>
When analyzing a file such as Malware.apk, the AndroidManifest.xml file is always present.<br>

앞서 분석한 악성 권한들은 AndroidManifest.xml에 작성되어야 시스템으로부터 권한을 받을 수 있습니다.<br>
Malware.apk같은 파일을 스캔하면 반드시 AndroidManifest.xml 파일이 존재합니다. 
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
* LOCATIONS<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/23.png)<br>
![image 1](/Pictur/Hacking%20lab/malwareanalysis/24.png)<br>

Server locations refer to the physical geographic locations shown on the map.<br>
Domain malware checks verify whether domains are listed on security industry blacklists, enabling communication channels to be blocked after verification.<br> 
URLs represent the web addresses that the malware actually connects to using the INTERNET permission.<br>

SERVER LOCATIONS는 말 그대로 지도의 물리적 위치를 말합니다.<br>
DOMAIN MALWARE CHECK는 보안업계의 블랙리스트로 등록이 되어있는지 확인 과정이며, 과정 후 통로를 차단할 수 있습니다.<br>
URLS은 Malware가 INTERNET 권한을 통해 실제로 접속하는 웹 주소 목록입니다.
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
* MANAFIESET<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/25.png)<br>

For security, the allowBackup flag should be set to false. When the flag is missing, it defaults to true and becomes enabled.<br>
This permits backups and implies that the entire application internal storage (sandbox), rather than only standard user data, can be copied.<br>

allowbackup의 flag는 False로 설정되있어야 안전합니다. flag is missing 누락으로 기본값인 true로 활성화됩니다.<br>
이는 백업 허용으로 일반 백업과는 다른 앱 내부 저장소(Sandbox)를 통째로 복제함을 의미합니다. 
<br>
<br>
<br>


![image 1](/Pictur/Hacking%20lab/malwareanalysis/26.png)<br>

Upon receipt of the RECEIVE_BOOT_COMPLETED broadcast, the broadcast receiver initiates .MainService.<br>
Because the service is configured with exported=true,<br>
it can be accessed by other applications, enabling external triggering and sustained remote control through the C2 server.<br>

시스템이 부팅 신호(RECEIVE_BOOT_COMPLETED)를 보내면 브로드캐스트(Broadcast Receiver)가 신호를 받습니다.<br>
그 후, .Mainservice가 실행되고 exported=true로 자기 앱의 서비스만 가능한 것을 다른 앱이 간섭을 받게 설정합니다.<br> 
외부 간섭으로 깨어난 서비스는 C2 서버로 원격제어가 유지됩니다<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

* Code Analysis<br>

<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/27.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/28.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/29.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/30.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/31.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/32.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/33.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/34.png)<br>

<br>
<br>
<br>
<br>
<br>

![image 1](/Pictur/Hacking%20lab/malwareanalysis/35.png)<br>
